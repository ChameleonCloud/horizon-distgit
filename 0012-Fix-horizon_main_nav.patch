From ad701586b5103c0ba4f6d69689ef316f9490b582 Mon Sep 17 00:00:00 2001
From: Matthias Runge <mrunge@redhat.com>
Date: Thu, 11 Sep 2014 17:27:39 +0200
Subject: [PATCH] Fix horizon_main_nav

---
 horizon/templatetags/horizon.py | 24 ++++++++++++------------
 1 file changed, 12 insertions(+), 12 deletions(-)

diff --git a/horizon/templatetags/horizon.py b/horizon/templatetags/horizon.py
index 0fc80ca..d98568f 100644
--- a/horizon/templatetags/horizon.py
+++ b/horizon/templatetags/horizon.py
@@ -37,7 +37,7 @@ def has_permissions(user, component):
 @register.filter
 def has_permissions_on_list(components, user):
     return [component for component
-                in components if has_permissions(user, component)]
+            in components if has_permissions(user, component)]
 
 
 @register.inclusion_tag('horizon/_accordion_nav.html', takes_context=True)
@@ -57,15 +57,14 @@ def horizon_nav(context):
                    panel.can_access(context):
                     allowed_panels.append(panel)
                 elif not callable(panel.nav) and panel.nav and \
-                         panel.can_access(context):
+                        panel.can_access(context):
                     allowed_panels.append(panel)
             if allowed_panels:
                 non_empty_groups.append((group.name, allowed_panels))
         if callable(dash.nav) and dash.nav(context) and \
            dash.can_access(context):
             dashboards.append((dash, SortedDict(non_empty_groups)))
-        elif not callable(dash.nav) and dash.nav and \
-             dash.can_access(context):
+        elif not callable(dash.nav) and dash.nav and dash.can_access(context):
             dashboards.append((dash, SortedDict(non_empty_groups)))
     return {'components': dashboards,
             'user': context['request'].user,
@@ -82,11 +81,11 @@ def horizon_main_nav(context):
     current_dashboard = context['request'].horizon.get('dashboard', None)
     dashboards = []
     for dash in Horizon.get_dashboards():
-        if dash.can_access(context['request']):
-            if callable(dash.nav) and dash.nav(context):
-                dashboards.append(dash)
-            elif dash.nav:
-                dashboards.append(dash)
+        if callable(dash.nav) and dash.nav(context) and \
+                dash.can_access(context):
+                    dashboards.append(dash)
+        elif not callable(dash.nav) and dash.nav and dash.can_access(context):
+            dashboards.append(dash)
     return {'components': dashboards,
             'user': context['request'].user,
             'current': current_dashboard,
@@ -107,9 +106,10 @@ def horizon_dashboard_nav(context):
         for panel in group:
             if callable(panel.nav) and panel.nav(context) and \
                panel.can_access(context):
-                allowed_panels.append(panel)
-            elif not callable(panel.nav) and panel.nav and \
-                 panel.can_access(context):
+                    allowed_panels.append(panel)
+            elif not (callable(panel.nav) and
+                      panel.nav and
+                      panel.can_access(context)):
                 allowed_panels.append(panel)
         if allowed_panels:
             non_empty_groups.append((group.name, allowed_panels))
